angular.module("identityHub",[]);angular.module("identityHub").provider("identityService",function(){var n=this;return this.config=function(t){n.oauthParameters=t;var i=n.oauthParameters.baseUrl;if(typeof i!="string")throw{error:"The baseUrl is required."};i=i.trim();i[i.length-1]==="/"&&(i=i.substring(0,i.length-1));n.oauthParameters.baseUrl=i},this.$get=["$http","$q","$interval","$window",function(n,t,i,r){function s(n){var t,u,i,r;if((n[0]==="?"||n[0]==="#")&&(n=n.substr(1,n.length-1)),n[0]==="/"&&(n=n.substr(1,n.length-1)),t=n.split("&"),u=[],t&&t.length>0)for(i=0;i<t.length;i++)r=t[i].split("="),r.length===2&&(u[r[0]]=decodeURIComponent(r[1]));return u}var u=this,e=[],o=this,f={signIn:function(n){var f=t.defer(),i=u.oauthParameters.baseUrl+"/oauth2/v1/auth?response_type=token&client_id="+encodeURIComponent(u.oauthParameters.clientId)+"&redirect_uri="+encodeURIComponent(u.oauthParameters.redirectUri);return u.oauthParameters.scopes!==undefined&&(i+="&scope="+encodeURIComponent(u.oauthParameters.scopes)),i+=n&&n!==""?"&state="+encodeURIComponent(n):"&state="+encodeURIComponent(r.location.hash),u.oauthParameters.popup?u.authenticationBroker({url:i,redirectUri:o.oauthParameters.redirectUri,width:600,height:500}).then(function(n){o.parseResponse(n.hash);f.resolve()}):(r.location.href=i,f.resolve()),f.promise},signOut:function(){var i=t.defer(),r=u.getToken();return sessionStorage.removeItem("access_token"),f.principal.isAuthenticated=!1,f.principal.isVerified=!1,f.principal.identity=null,n({method:"POST",url:u.oauthParameters.baseUrl+"/oauth2/v1/revoke",data:$.param({token:r.access_token,token_type_hint:"access_token",client_id:u.oauthParameters.clientId}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(n){i.resolve(n)}).error(function(n){i.reject(n)}),i.promise},getProfile:function(){var i=t.defer(),r=u.getToken();return n.get(u.oauthParameters.baseUrl+"/api/identity/v1/",{headers:{Authorization:"Bearer "+r.access_token}}).success(function(n){f.principal.identity=n;i.resolve(n)}).error(function(n){i.reject(n)}),i.promise},getFriends:function(){var i=t.defer(),r=u.getToken();return n.get(u.oauthParameters.baseUrl+"/api/identity/v1/friends",{headers:{Authorization:"Bearer "+r.access_token}}).success(function(n){i.resolve(n)}).error(function(n){i.reject(n)}),i.promise},getRoles:function(){var i=t.defer(),r=u.getToken();return n.get(u.oauthParameters.baseUrl+"/api/identity/v1/roles",{headers:{Authorization:"Bearer "+r.access_token}}).success(function(n){f.principal.roles=n;i.resolve(n)}).error(function(n){i.reject(n)}),i.promise},getAccounts:function(){var i=t.defer(),r=u.getToken();return n.get(u.oauthParameters.baseUrl+"/api/identity/v1/accounts",{headers:{Authorization:"Bearer "+r.access_token}}).success(function(n){i.resolve(n)}).error(function(n){i.reject(n)}),i.promise},requireTwoFactorAuthentication:function(){var i=t.defer(),r=u.getToken();return f.principal.isVerified?(i.resolve(!0),i.promise):(n.get(u.oauthParameters.baseUrl+"/oauth2/v1/verify",{headers:{Authorization:"Bearer "+r.access_token}}).success(function(n){if(n&&n.resource_owner_identity_verified)f.principal.isVerified=!0,i.resolve(!0);else{var t=u.oauthParameters.baseUrl+"/Authenticate/PerformTwoFactorAuthenticationVerification?accessToken="+r.access_token+"&clientId="+u.oauthParameters.clientId+"&returnUrl="+encodeURIComponent(u.oauthParameters.redirectUri);u.authenticationBroker({url:t,redirectUri:u.oauthParameters.redirectUri,width:600,height:500}).then(function(n){var t="resource_owner_identity_verified=",r=n.href.indexOf(t),u;r!=-1&&n.href.length>=r+(t.length+1)?(u=n.href[r+t.length]=="1",f.principal.isVerified=u,i.resolve(u)):i.resolve(!1)})}}).error(function(n){i.reject(n)}),i.promise)},addAccount:function(n){var i=t.defer(),r=u.getToken();return u.authenticationBroker({url:n.signInUrl+"?access_token="+r.access_token+"&returnurl="+encodeURIComponent(u.oauthParameters.redirectUri),redirectUri:u.oauthParameters.redirectUri,width:600,height:500}).then(function(){i.resolve()}),i.promise},principal:{isAuthenticated:!1,isVerified:!1,token:null,identity:null,roles:[],isInRole:function(n){var t=!1;return $.each(f.principal.roles,function(i,r){return t=r.name===n,!t}),t}}};return this.authenticationBroker=function(n){var f=t.defer(),e=r.screenX+(r.outerWidth-n.width)/2,o=r.screenY+(r.outerHeight-n.height)/2,s="status=0,resizable=0,scrollbars=1,location=0,toolbar=0,menubar=0,titlebar=0,left= "+e+",top="+o+",height="+n.height+",width="+n.width,u=r.open(n.url,"Authenticate",s),h=i(function(){try{if(u.location.href.indexOf(n.redirectUri)>=0){var t={href:u.location.href,hash:u.location.hash,search:u.location.search};setTimeout(function(){f.resolve(t)},1e3);u.close();u=null;i.cancel(h)}}catch(r){}},1e3);return f.promise},this.getToken=function(){var n,t=(new Date).getTime();if(f.principal&&f.principal!==undefined&&f.principal.token&&f.principal.token!==undefined){if(n=f.principal.token,n&&n.access_token&&n.expiry>t)return n}else if(n=JSON.parse(sessionStorage.getItem("access_token")),n&&n.access_token&&n.expiry>t)return n;f.principal.token=null;f.principal.roles=[];f.principal.isAuthenticated=!1;sessionStorage.removeItem("access_token");u.oauthParameters.manualSignIn||f.signIn()},this.setToken=function(n){return n&&n.access_token&&n.access_token!==""&&(f.principal.token={access_token:n.access_token,expiry:(new Date).getTime()+n.expires_in*1e3,scope:n.scope},f.principal.isAuthenticated=!0,f.principal.isVerified=n.resource_owner_identity_verified==="1",sessionStorage.setItem("access_token",JSON.stringify(f.principal.token))),null},this.parseResponse=function(n){var i,t;if(n&&n!==""||(n=window.location.hash),n&&n!==""&&(i=s(n),u.setToken(i),f.principal.isAuthenticated)){f.getProfile();f.getRoles();t=i.state;window.location.hash=t&&t!==""?t:"";return}u.oauthParameters.manualSignIn||f.signIn()},e.invalid_request="The request is missing a required parameter, includes an invalid parameter value, includes a parameter more than once, or is otherwise malformed.",e.invalid_client="Invalid client",e.invalid_grant="Invalid grant",e.invalid_token="The token is invlaid.",e.unauthorized_client="The client is not authorized to request an access token using this method.",e.unsupported_grant_type="Unsupported grant type.",e.unsupported_response_type="The authorization server does not support obtaining an access token using this method.",e.invalid_scope="The requested scope is invalid, unknown, or malformed.",e.access_denied="The resource owner or authorization server denied the request.",e.server_error="The authorization server encountered an unexpected condition that prevented it from fulfilling the request. (This error code is needed because a 500 Internal Server Error HTTP status code cannot be returned to the client via an HTTP redirect.)",e.unsupported_token_type="The authorization server does not support the revocation of the presented token type.  That is, the client tried to revoke an access token on a server not supporting this feature.",this.parseResponse(),f}],this});