angular.module("identityHub",[]),angular.module("identityHub").provider("identityService",function(){var a=this;return this.init=function(b){a.oauthParameters=b},this.$get=["$http","$q","$interval",function(a,b,c){function d(a){("?"===a[0]||"#"===a[0])&&(a=a.substr(1,a.length-1)),"/"===a[0]&&(a=a.substr(1,a.length-1));var b=a.split("&"),c=[];if(b&&b.length>0)for(var d=0;d<b.length;d++){var e=b[d].split("=");2===e.length&&(c[e[0]]=decodeURIComponent(e[1]))}return c}var e=this,f=[],g=this,h={signIn:function(a){var b=e.oauthParameters.baseUrl+"/oauth2/v1/auth?response_type=token&client_id="+encodeURIComponent(e.oauthParameters.clientId)+"&redirect_uri="+encodeURIComponent(e.oauthParameters.redirectUri);if(void 0!==e.oauthParameters.scopes&&(b+="&scope="+encodeURIComponent(e.oauthParameters.scopes)),b+=a&&""!==a?"&state="+encodeURIComponent(a):"&state="+encodeURIComponent(window.location.hash),e.oauthParameters.popup)var d=window.screenX+(window.outerWidth-600)/2,f=window.screenY+(window.outerHeight-400)/2,h="status=0,resizable=0,location=0,toolbar=0,menubar=0,titlebar=0,left="+d+",top="+f+",height=400px,width=600px",i=window.open(b,null,h),j=c(function(){var a;try{i.location.href.indexOf(g.oauthParameters.redirectUri)>=0&&(a=i.location.hash,setTimeout(function(){g.parseResponse(a)},1e3),i.close(),i=null,c.cancel(j))}catch(b){}},1e3);else window.location.href=b},getProfile:function(){var c=b.defer(),d=e.getToken();return a.get(e.oauthParameters.baseUrl+"/api/identity/v1/",{headers:{Authorization:"Bearer "+d.access_token}}).success(function(a){h.principal.identity=a,c.resolve(a)}).error(function(a){c.reject(a)}),c.promise},getFriends:function(){var c=b.defer(),d=e.getToken();return a.get(e.oauthParameters.baseUrl+"/api/identity/v1/friends",{headers:{Authorization:"Bearer "+d.access_token}}).success(function(a){c.resolve(a)}).error(function(a){c.reject(a)}),c.promise},principal:{isAuthenticated:!1,token:null,identity:null}};return this.getToken=function(){if(h.principal&&void 0!==h.principal){var a=h.principal.token,b=(new Date).getTime();if(a&&a.access_token&&a.expiry>b)return a;h.principal.token=null,h.principal.isAuthenticated=!1}e.oauthParameters.manualSignIn||h.signIn()},this.setToken=function(a){return a&&a.access_token&&""!==a.access_token&&(h.principal.token={access_token:a.access_token,expiry:(new Date).getTime()+1e3*a.expires_in,scope:a.scope},h.principal.isAuthenticated=!0),null},this.parseResponse=function(a,b){var c;if(a&&""!==a||(a=window.location.hash),a&&""!==a&&(c=d(a),e.setToken(c),h.principal.isAuthenticated)){h.getProfile(),b&&b(c);var f=c.state;return void(window.location.hash=f&&""!==f?f:"")}e.oauthParameters.manualSignIn||h.signIn()},f.invalid_request="The request is missing a required parameter, includes an invalid parameter value, includes a parameter more than once, or is otherwise malformed.",f.invalid_client="Invalid client",f.invalid_grant="Invalid grant",f.invalid_token="The token is invlaid.",f.unauthorized_client="The client is not authorized to request an access token using this method.",f.unsupported_grant_type="Unsupported grant type.",f.unsupported_response_type="The authorization server does not support obtaining an access token using this method.",f.invalid_scope="The requested scope is invalid, unknown, or malformed.",f.access_denied="The resource owner or authorization server denied the request.",f.server_error="The authorization server encountered an unexpected condition that prevented it from fulfilling the request. (This error code is needed because a 500 Internal Server Error HTTP status code cannot be returned to the client via an HTTP redirect.)",f.unsupported_token_type="The authorization server does not support the revocation of the presented token type.  That is, the client tried to revoke an access token on a server not supporting this feature.",this.parseResponse(),h}],this});